<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mindful Finance Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #F9F7F2; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .card { background-color: #FFFFFF; border-radius: 20px; border: 1px solid #E5E2D9; }
        .btn-primary { background-color: #7DA67D; color: white; border-radius: 14px; }
        .accent-text { color: #5B7A5B; }
        .tab { padding: 8px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer; background: #F0EEE6; color: #8A877F; white-space: nowrap; }
        .tab.active { background: #7DA67D; color: white; }
        .cat-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #view-wrapper { display: flex; width: 200%; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .page { width: 50%; padding: 16px; min-height: 100vh; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: #8A877F; text-transform: uppercase; font-size: 10px; letter-spacing: 0.1em; padding: 12px 8px; border-bottom: 1px solid #E5E2D9; }
        td { padding: 12px 8px; border-bottom: 1px dashed #F0EEE6; }
    </style>
</head>
<body>

    <div id="view-wrapper">
        <div class="page" id="page-dashboard">
            <header class="mb-6 text-center pt-4">
                <h1 class="text-[10px] uppercase tracking-[0.2em] text-stone-400 font-bold mb-1">Estimated Net Worth</h1>
                <div id="net-worth" class="text-4xl font-light accent-text">£0.00</div>
                <div class="flex justify-center gap-4 mt-2 text-[11px] font-bold">
                    <span id="stat-in" class="text-green-600">IN: £0.00</span>
                    <span id="stat-out" class="text-red-400">OUT: £0.00</span>
                </div>
            </header>

            <div class="card p-3 mb-4 flex justify-between items-center bg-stone-50 border-stone-200">
                <div>
                    <p class="text-[9px] uppercase font-bold text-stone-400">Vanguard VHVG (LSE)</p>
                    <p id="vhvg-price" class="text-xl font-semibold accent-text">£0.00</p>
                    <p id="last-updated" class="text-[8px] text-stone-400 uppercase mt-1">Syncing...</p>
                </div>
                <div class="text-right">
                    <p id="vhvg-change" class="text-sm font-bold text-stone-400">--%</p>
                    <div id="vhvg-indicator" class="inline-block w-2 h-2 rounded-full bg-stone-200"></div>
                </div>
            </div>

            <div class="card p-4 mb-6 shadow-sm">
                <canvas id="spendChart" style="max-height: 180px; margin-bottom: 15px;"></canvas>
                <div class="flex justify-center">
                    <button onclick="switchPage(1)" class="text-[10px] font-bold text-stone-400 border border-stone-200 px-4 py-1 rounded-full uppercase">Vault & Data →</button>
                </div>
            </div>

            <div id="account-grid" class="grid grid-cols-2 gap-2 mb-6 text-center text-stone-700"></div>

            <div class="card p-5 mb-6 shadow-sm">
                <div class="flex gap-2 overflow-x-auto pb-3 mb-3 no-scrollbar" id="cat-selector"></div>
                <div class="space-y-3">
                    <div class="flex bg-stone-100 p-1 rounded-xl">
                        <button onclick="setType('out')" id="tgl-out" class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow-sm text-red-500">EXPENSE</button>
                        <button onclick="setType('in')" id="tgl-in" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-stone-400">INCOME</button>
                    </div>
                    <input id="desc" type="text" placeholder="Description" class="w-full bg-stone-50 p-3 rounded-xl outline-none border border-stone-100">
                    <div class="flex gap-2">
                        <input id="amt" type="number" inputmode="decimal" placeholder="0.00" class="w-full bg-stone-50 p-3 rounded-xl outline-none border border-stone-100 text-lg">
                        <button onclick="addEntry()" id="add-btn" class="btn-primary px-6 font-bold shadow-md active:scale-95 transition">Add</button>
                    </div>
                </div>
            </div>

            <ul id="list" class="space-y-2 pb-10"></ul>
        </div>

        <div class="page" id="page-table">
            <header class="mb-6 flex justify-between items-center pt-4">
                <button onclick="switchPage(0)" class="text-[10px] font-bold text-stone-400 border border-stone-200 px-3 py-1 rounded-full uppercase">← Back</button>
                <h2 class="text-sm font-bold text-stone-500 uppercase tracking-widest">Vault & Data</h2>
                <div style="width: 50px"></div>
            </header>

            <div class="card p-5 mb-6 shadow-sm space-y-4">
                <p class="text-[10px] font-bold text-stone-400 uppercase">Privacy & Backup</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportJSON()" class="text-[10px] font-bold bg-stone-100 text-stone-600 p-3 rounded-xl uppercase hover:bg-stone-200 transition">Export JSON</button>
                    <label class="text-[10px] font-bold bg-stone-100 text-stone-600 p-3 rounded-xl uppercase text-center cursor-pointer hover:bg-stone-200 transition">
                        Import JSON
                        <input type="file" id="import-file" class="hidden" onchange="importJSON(event)">
                    </label>
                </div>
                <p class="text-[9px] text-stone-400 leading-tight">Data is stored locally in your browser. Export a backup frequently to ensure you don't lose your history.</p>
            </div>

            <div class="card p-4 mb-6 shadow-sm">
                <p class="text-[10px] font-bold text-stone-400 uppercase mb-4">Spending by Category</p>
                <div id="table-container"></div>
            </div>
            
            <button onclick="resetData()" class="w-full text-[10px] text-red-300 py-8 uppercase tracking-widest font-bold">Wipe Local Device Data</button>
        </div>
    </div>

    <script>
        let currentCat = 'Misc';
        let currentType = 'out';
        let chartInstance = null;
        let lastKnownPrice = 0;

        const CONFIG = {
            categories: ['Housing', 'Transport', 'Food', 'Ent', 'Savings', 'Misc'],
            base: { savings: 0, pension: 0, debt: 0 },
            vhvgUnits: 0 
        };

        // --- VAULT LOGIC ---
        async function exportJSON() {
            const data = await localforage.getItem('finance_v2') || [];
            const backup = { timestamp: new Date().toISOString(), payload: data };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        async function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.payload && confirm("Overwrite current local data with this backup?")) {
                        await localforage.setItem('finance_v2', imported.payload);
                        load();
                        alert("Vault Restored");
                    }
                } catch (err) { alert("Invalid File Format"); }
            };
            reader.readAsText(file);
        }

        // --- CORE LOGIC ---
        async function fetchVHVG() {
            try {
                const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/VHVG.L`);
                const data = await response.json();
                const quote = data.chart.result[0].meta;
                lastKnownPrice = quote.regularMarketPrice;
                document.getElementById('vhvg-price').innerText = `£${lastKnownPrice.toFixed(2)}`;
                document.getElementById('last-updated').innerText = `Last Known: ${new Date().toLocaleTimeString()}`;
                const change = ((lastKnownPrice - quote.previousClose) / quote.previousClose * 100).toFixed(2);
                const changeEl = document.getElementById('vhvg-change');
                changeEl.innerText = `${change > 0 ? '+' : ''}${change}%`;
                changeEl.className = change >= 0 ? 'text-sm font-bold text-green-600' : 'text-sm font-bold text-red-400';
                load();
            } catch (e) { document.getElementById('last-updated').innerText = "Syncing..."; }
        }

        function switchPage(index) {
            document.getElementById('view-wrapper').style.transform = `translateX(-${index * 50}%)`;
        }

        function setCat(cat) { currentCat = cat; renderTabs(); }

        function setType(type) {
            currentType = type;
            const btnIn = document.getElementById('tgl-in');
            const btnOut = document.getElementById('tgl-out');
            if(type === 'in') {
                btnIn.className = "flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow-sm text-green-600";
                btnOut.className = "flex-1 py-2 rounded-lg text-xs font-bold transition text-stone-400";
                document.getElementById('add-btn').style.backgroundColor = "#7DA67D";
            } else {
                btnOut.className = "flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow-sm text-red-500";
                btnIn.className = "flex-1 py-2 rounded-lg text-xs font-bold transition text-stone-400";
                document.getElementById('add-btn').style.backgroundColor = "#A67D7D";
            }
        }

        function renderTabs() {
            document.getElementById('cat-selector').innerHTML = CONFIG.categories.map(c => 
                `<div class="tab ${currentCat === c ? 'active' : ''}" onclick="setCat('${c}')">${c}</div>`
            ).join('');
        }

        async function load() {
            const data = await localforage.getItem('finance_v2') || [];
            let totalIn = 0; let totalOut = 0;
            const catSummary = {};
            CONFIG.categories.forEach(c => catSummary[c] = 0);

            data.forEach(e => {
                const val = parseFloat(e.amt);
                if(e.type === 'in') totalIn += val; 
                else { totalOut += val; catSummary[e.cat] = (catSummary[e.cat] || 0) + val; }
            });

            const investmentValue = lastKnownPrice * CONFIG.vhvgUnits;
            const netVal = CONFIG.base.savings + CONFIG.base.pension + CONFIG.base.debt + investmentValue + totalIn - totalOut;
            
            document.getElementById('net-worth').innerText = `£${netVal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('stat-in').innerText = `IN: £${totalIn.toLocaleString()}`;
            document.getElementById('stat-out').innerText = `OUT: £${totalOut.toLocaleString()}`;

            document.getElementById('account-grid').innerHTML = `
                <div class="card p-3"><p class="text-[9px] uppercase text-stone-400">Savings</p><p class="text-sm font-bold">£${CONFIG.base.savings.toLocaleString()}</p></div>
                <div class="card p-3"><p class="text-[9px] uppercase text-stone-400">Investments</p><p class="text-sm font-bold">£${investmentValue.toLocaleString(undefined, {maximumFractionDigits:0})}</p></div>
                <div class="card p-3"><p class="text-[9px] uppercase text-stone-400">Debt</p><p class="text-sm font-bold text-red-400">£${CONFIG.base.debt.toLocaleString()}</p></div>
                <div class="card p-3 bg-stone-50"><p class="text-[9px] uppercase text-stone-400">Flow</p><p class="text-sm font-bold ${totalIn-totalOut >= 0 ? 'text-green-600' : 'text-red-400'}">£${(totalIn-totalOut).toFixed(0)}</p></div>
            `;

            document.getElementById('list').innerHTML = data.slice().reverse().map((e, idx) => `
                <li class="flex justify-between items-center p-4 card shadow-sm">
                    <div><p class="text-sm font-semibold text-stone-700">${e.desc}</p><span class="cat-badge ${e.type==='in'?'bg-green-100 text-green-700':'bg-stone-100 text-stone-500'}">${e.cat}</span></div>
                    <div class="text-right"><p class="font-bold ${e.type==='in'?'text-green-600':'text-stone-700'}">${e.type==='in'?'+':'-'}£${parseFloat(e.amt).toFixed(2)}</p><button onclick="deleteEntry(${data.length-1-idx})" class="text-[10px] text-stone-300">Delete</button></div>
                </li>
            `).join('');

            renderCategoryTable(catSummary);
            updateChart(catSummary);
        }

        function renderCategoryTable(summary) {
            let html = `<table><thead><tr><th>Category</th><th>Total</th></tr></thead><tbody>`;
            for (const cat in summary) {
                html += `<tr><td class="font-semibold text-stone-600">${cat}</td><td class="text-right font-bold text-stone-800">£${summary[cat].toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
            }
            document.getElementById('table-container').innerHTML = html + `</tbody></table>`;
        }

        function updateChart(catTotals) {
            const ctx = document.getElementById('spendChart').getContext('2d');
            const labels = Object.keys(catTotals).filter(k => catTotals[k] > 0);
            const values = labels.map(k => catTotals[k]);
            if (chartInstance) chartInstance.destroy();
            if (labels.length === 0) return;
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: ['#7DA67D', '#9DBE9D', '#C2D6C2', '#E5E2D9', '#8A877F', '#A67D7D'], borderWidth: 0 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } }, cutout: '75%' }
            });
        }

        async function addEntry() {
            const desc = document.getElementById('desc').value; const amt = document.getElementById('amt').value;
            if(!desc || !amt) return;
            const data = await localforage.getItem('finance_v2') || [];
            data.push({ desc, amt: Math.abs(parseFloat(amt)), cat: currentCat, type: currentType, date: new Date().toISOString() });
            await localforage.setItem('finance_v2', data);
            document.getElementById('desc').value = ''; document.getElementById('amt').value = '';
            load();
        }

        async function deleteEntry(idx) {
            const data = await localforage.getItem('finance_v2') || [];
            data.splice(idx, 1); await localforage.setItem('finance_v2', data);
            load();
        }

        async function resetData() { if(confirm("Wipe all data?")) { await localforage.clear(); load(); } }

        document.addEventListener('DOMContentLoaded', () => {
            renderTabs(); load(); fetchVHVG(); setInterval(fetchVHVG, 300000);
        });
    </script>
</body>
</html>
