<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mindful Finance Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #F9F7F2; -webkit-tap-highlight-color: transparent; overflow: hidden; font-family: sans-serif; }
        .card { background-color: #FFFFFF; border-radius: 20px; border: 1px solid #E5E2D9; transition: all 0.2s ease; }
        .btn-primary { background-color: #7DA67D; color: white; border-radius: 14px; }
        .accent-text { color: #5B7A5B; }
        .tab { padding: 8px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer; background: #F0EEE6; color: #8A877F; white-space: nowrap; }
        .tab.active { background: #7DA67D; color: white; }
        .cat-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #snap-container { 
            display: flex; 
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            scroll-behavior: smooth; 
            height: 100vh;
            width: 100vw;
        }
        .page { 
            min-width: 100vw; 
            height: 100%; 
            scroll-snap-align: start; 
            overflow-y: auto; 
            padding: 16px; 
            padding-bottom: 80px; 
        }
        
        #dots { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; pointer-events: none; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #E5E2D9; transition: all 0.3s; }
        .dot.active { background: #7DA67D; width: 18px; border-radius: 3px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: #8A877F; text-transform: uppercase; font-size: 10px; letter-spacing: 0.1em; padding: 12px 8px; border-bottom: 1px solid #E5E2D9; }
        td { padding: 12px 8px; border-bottom: 1px dashed #F0EEE6; }

        .editing-highlight { border: 2px solid #7DA67D !important; background-color: #f0fdf4; }
        input, select { outline: none; border: 1px solid #E5E2D9; }
        input:focus { border-color: #7DA67D; }
    </style>
</head>
<body>

    <div id="snap-container" onscroll="updateDots()">
        <div class="page" id="page-dashboard">
            <header class="mb-6 text-center pt-4">
                <h1 class="text-[10px] uppercase tracking-[0.2em] text-stone-400 font-bold mb-1">Total Net Worth</h1>
                <div id="net-worth" class="text-4xl font-light accent-text">£0.00</div>
                
                <div class="flex flex-col items-center mt-2">
                    <div class="flex justify-center gap-4 text-[11px] font-bold">
                        <span id="stat-in" class="text-green-600 uppercase">In: £0.00</span>
                        <span id="stat-out" class="text-red-400 uppercase">Out: £0.00</span>
                    </div>
                    <div id="stat-surplus" class="text-[10px] font-bold text-stone-500 mt-1 uppercase tracking-tighter bg-stone-100 px-3 py-1 rounded-full">
                        Monthly Surplus: £0.00
                    </div>
                </div>
            </header>

            <div id="wealth-grid" class="grid grid-cols-3 gap-2 mb-6 text-center"></div>

            <div class="card p-4 mb-6 shadow-sm">
                <p class="text-[10px] uppercase tracking-wider text-stone-400 font-bold mb-4 text-center">Spending Distribution</p>
                <canvas id="spendChart" style="max-height: 180px;"></canvas>
            </div>

            <div id="input-card" class="card p-5 mb-6 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <p id="form-title" class="text-[10px] uppercase text-stone-400 font-bold">Add Transaction</p>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden text-[10px] uppercase font-bold text-red-400">Cancel</button>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-3 mb-3 no-scrollbar" id="cat-selector"></div>
                <div class="space-y-3">
                    <div class="flex bg-stone-100 p-1 rounded-xl">
                        <button onclick="setType('out')" id="tgl-out" class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow-sm text-red-500">EXPENSE</button>
                        <button onclick="setType('in')" id="tgl-in" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-stone-400">INCOME</button>
                    </div>
                    <input id="desc" type="text" placeholder="Description" class="w-full bg-stone-50 p-3 rounded-xl">
                    <div class="flex gap-2">
                        <input id="amt" type="number" inputmode="decimal" placeholder="0.00" class="w-full bg-stone-50 p-3 rounded-xl text-lg">
                        <button onclick="addEntry()" id="add-btn" class="btn-primary px-6 font-bold shadow-md active:scale-95 transition">Add</button>
                    </div>
                </div>
            </div>
            <ul id="list" class="space-y-2 pb-10"></ul>
        </div>

        <div class="page" id="page-table">
            <header class="mb-6 pt-4 text-center">
                <h2 class="text-sm font-bold text-stone-500 uppercase tracking-widest">Vault & Accounts</h2>
            </header>

            <div class="card p-5 mb-6 shadow-sm">
                <p class="text-[10px] font-bold text-stone-400 uppercase mb-4">Manage Accounts</p>
                <div id="account-list" class="space-y-4 mb-4"></div>
                
                <div class="pt-4 border-t border-dashed border-stone-200">
                    <p class="text-[9px] font-bold text-stone-400 uppercase mb-2">New Account</p>
                    <div class="flex flex-col gap-2">
                        <input id="new-acc-name" type="text" placeholder="Account Name" class="bg-stone-50 p-2 rounded-lg text-xs">
                        <div class="flex gap-2">
                            <select id="new-acc-type" class="bg-stone-100 p-2 rounded-lg text-[10px] font-bold uppercase cursor-pointer">
                                <option value="savings">Savings</option>
                                <option value="investments">Invested</option>
                                <option value="debt">Debt</option>
                            </select>
                            <button onclick="addAccount()" class="btn-primary flex-1 py-2 text-[10px] font-bold uppercase">Add Account</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 shadow-sm mb-6">
                <p class="text-[10px] font-bold text-stone-400 uppercase mb-4">Detailed History</p>
                <div class="flex gap-2 overflow-x-auto pb-3 mb-4 no-scrollbar" id="table-cat-selector"></div>
                <div id="table-container" class="overflow-hidden"></div>
            </div>

            <div class="card p-5 mb-6 shadow-sm flex gap-3">
                <button onclick="exportJSON()" class="flex-1 text-[10px] font-bold bg-stone-100 text-stone-600 p-3 rounded-xl uppercase">Export</button>
                <label class="flex-1 text-[10px] font-bold bg-stone-100 text-stone-600 p-3 rounded-xl uppercase text-center cursor-pointer">
                    Import <input type="file" id="import-file" class="hidden" onchange="importJSON(event)">
                </label>
            </div>
            <button onclick="resetData()" class="w-full text-[10px] text-red-300 py-8 uppercase tracking-widest font-bold">Wipe All Data</button>
        </div>
    </div>

    <div id="dots"><div class="dot active"></div><div class="dot"></div></div>

    <script>
        let currentCat = 'Misc';
        let tableFilterCat = 'All';
        let currentType = 'out';
        let chartInstance = null;
        let editIndex = null;
        let ACCOUNTS = [];

        const CONFIG = { monthlyCategories: ['Housing', 'Food', 'Transport', 'Ent', 'Bills', 'Misc'] };

        function updateDots() {
            const index = Math.round(document.getElementById('snap-container').scrollLeft / window.innerWidth);
            document.querySelectorAll('.dot').forEach((dot, i) => dot.classList.toggle('active', i === index));
        }

        // --- ACCOUNT LOGIC ---
        async function addAccount() {
            const name = document.getElementById('new-acc-name').value;
            const type = document.getElementById('new-acc-type').value;
            if(!name) return;
            ACCOUNTS.push({ id: Date.now(), name, type, balance: 0 });
            await localforage.setItem('accounts_v3', ACCOUNTS);
            document.getElementById('new-acc-name').value = '';
            load();
        }

        async function updateAccountDetail(id, field, value) {
            const idx = ACCOUNTS.findIndex(a => a.id === id);
            if (field === 'balance') ACCOUNTS[idx].balance = parseFloat(value) || 0;
            else ACCOUNTS[idx][field] = value;
            await localforage.setItem('accounts_v3', ACCOUNTS);
            load();
        }

        async function deleteAccount(id) {
            if(!confirm("Delete this account?")) return;
            ACCOUNTS = ACCOUNTS.filter(a => a.id !== id);
            await localforage.setItem('accounts_v3', ACCOUNTS);
            load();
        }

        // --- TAB LOGIC ---
        function renderTabs() {
            document.getElementById('cat-selector').innerHTML = CONFIG.monthlyCategories.map(c => 
                `<div class="tab ${currentCat === c ? 'active' : ''}" onclick="setCat('${c}')">${c}</div>`).join('');
            const tableCats = ['All', ...CONFIG.monthlyCategories];
            document.getElementById('table-cat-selector').innerHTML = tableCats.map(c => 
                `<div class="tab ${tableFilterCat === c ? 'active' : ''}" onclick="setTableFilter('${c}')">${c}</div>`).join('');
        }

        function setCat(c) { currentCat = c; renderTabs(); }
        function setTableFilter(c) { tableFilterCat = c; renderTabs(); load(); }
        function setType(t) {
            currentType = t;
            document.getElementById('tgl-in').className = t === 'in' ? "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-green-600" : "flex-1 py-2 rounded-lg text-xs font-bold text-stone-400";
            document.getElementById('tgl-out').className = t === 'out' ? "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-red-500" : "flex-1 py-2 rounded-lg text-xs font-bold text-stone-400";
            document.getElementById('add-btn').style.backgroundColor = t === 'in' ? "#7DA67D" : "#A67D7D";
        }

        // --- MAIN LOAD ---
        async function load() {
            const data = await localforage.getItem('finance_v2') || [];
            ACCOUNTS = await localforage.getItem('accounts_v3') || [];
            
            let mIn = 0, mOut = 0;
            const catSum = {};
            CONFIG.monthlyCategories.forEach(c => catSum[c] = 0);
            data.forEach(e => {
                const v = parseFloat(e.amt);
                if(e.type === 'in') mIn += v; else { mOut += v; catSum[e.cat] += v; }
            });

            const totals = ACCOUNTS.reduce((acc, curr) => {
                acc[curr.type] += curr.balance; return acc;
            }, { savings: 0, investments: 0, debt: 0 });

            const surplus = mIn - mOut;
            const netWorth = (totals.savings + totals.investments + mIn) - (totals.debt + mOut);

            // Dashboard Headers
            document.getElementById('net-worth').innerText = `£${netWorth.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('stat-in').innerText = `In: £${mIn.toLocaleString()}`;
            document.getElementById('stat-out').innerText = `Out: £${mOut.toLocaleString()}`;
            document.getElementById('stat-surplus').innerText = `Monthly Surplus: £${surplus.toLocaleString(undefined, {minimumFractionDigits:2})}`;
            document.getElementById('stat-surplus').className = surplus >= 0 
                ? "text-[10px] font-bold text-green-600 mt-1 uppercase tracking-tighter bg-green-50 px-3 py-1 rounded-full border border-green-100" 
                : "text-[10px] font-bold text-red-500 mt-1 uppercase tracking-tighter bg-red-50 px-3 py-1 rounded-full border border-red-100";

            // Grid Cards
            document.getElementById('wealth-grid').innerHTML = `
                <div class="card p-2 border-green-100 bg-green-50/30"><p class="text-[8px] uppercase text-stone-400">Savings</p><p class="text-xs font-bold">£${totals.savings.toLocaleString()}</p></div>
                <div class="card p-2 border-blue-100 bg-blue-50/30"><p class="text-[8px] uppercase text-stone-400 font-bold accent-text">Invested</p><p class="text-xs font-bold">£${totals.investments.toLocaleString()}</p></div>
                <div class="card p-2 border-red-100 bg-red-50/30"><p class="text-[8px] uppercase text-stone-400">Debt</p><p class="text-xs font-bold text-red-400">£${totals.debt.toLocaleString()}</p></div>`;

            // Page 2: Editable Account List
            document.getElementById('account-list').innerHTML = ACCOUNTS.map(a => `
                <div class="space-y-2 p-3 bg-stone-50 rounded-xl border border-stone-100">
                    <div class="flex gap-2">
                        <input type="text" value="${a.name}" onchange="updateAccountDetail(${a.id}, 'name', this.value)" class="flex-1 bg-white p-2 rounded-lg text-[10px] font-bold uppercase">
                        <select onchange="updateAccountDetail(${a.id}, 'type', this.value)" class="bg-white p-2 rounded-lg text-[10px] font-bold uppercase">
                            <option value="savings" ${a.type==='savings'?'selected':''}>Savings</option>
                            <option value="investments" ${a.type==='investments'?'selected':''}>Invested</option>
                            <option value="debt" ${a.type==='debt'?'selected':''}>Debt</option>
                        </select>
                        <button onclick="deleteAccount(${a.id})" class="text-stone-300 px-1">✕</button>
                    </div>
                    <div class="flex items-center bg-white rounded-lg p-1">
                        <span class="pl-2 text-stone-400 text-xs font-bold">£</span>
                        <input type="number" value="${a.balance}" onchange="updateAccountDetail(${a.id}, 'balance', this.value)" class="w-full bg-transparent p-2 text-sm font-bold border-none outline-none">
                    </div>
                </div>`).join('');

            // Transaction History
            document.getElementById('list').innerHTML = data.slice().reverse().map((e, idx) => {
                const oIdx = data.length - 1 - idx;
                return `<li class="flex justify-between items-center p-4 card shadow-sm ${editIndex === oIdx ? 'editing-highlight' : ''}">
                    <div><p class="text-sm font-semibold text-stone-700">${e.desc}</p><span class="cat-badge bg-stone-100 text-stone-500">${e.cat}</span></div>
                    <div class="text-right"><p class="font-bold ${e.type==='in'?'text-green-600':'text-stone-700'}">${e.type==='in'?'+':'-'}£${parseFloat(e.amt).toFixed(2)}</p>
                    <div class="flex gap-2 justify-end mt-1"><button onclick="startEdit(${oIdx})" class="text-[9px] text-stone-400 uppercase font-bold">Edit</button><button onclick="deleteEntry(${oIdx})" class="text-[9px] text-red-200 uppercase font-bold">Del</button></div></div>
                </li>`}).join('');

            renderTabbedTable(data);
            updateChart(catSum);
        }

        // --- CHART & TABLE HELPERS ---
        function renderTabbedTable(data) {
            const filtered = tableFilterCat === 'All' ? data : data.filter(i => i.cat === tableFilterCat);
            let h = `<table><thead><tr><th>Description</th><th class="text-right">Amount</th></tr></thead><tbody>`;
            if (filtered.length === 0) h += `<tr><td colspan="2" class="text-center py-8 text-stone-300 italic">No entries</td></tr>`;
            else filtered.slice().reverse().forEach(e => {
                h += `<tr><td class="font-medium text-stone-600">${e.desc}<br><span class="text-[8px] text-stone-400 uppercase">${new Date(e.date).toLocaleDateString()}</span></td>
                <td class="text-right font-bold ${e.type === 'in' ? 'text-green-600' : 'text-stone-800'}">${e.type === 'in' ? '+' : '-'}£${parseFloat(e.amt).toLocaleString()}</td></tr>`;
            });
            document.getElementById('table-container').innerHTML = h + `</tbody></table>`;
        }

        function updateChart(sums) {
            const ctx = document.getElementById('spendChart').getContext('2d');
            const labels = Object.keys(sums).filter(k => sums[k] > 0), values = labels.map(k => sums[k]);
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: ['#7DA67D', '#9DBE9D', '#C2D6C2', '#E5E2D9', '#8A877F', '#A67D7D'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } }, cutout: '75%' } });
        }

        // --- TRANSACTION HELPERS ---
        async function addEntry() {
            const d = document.getElementById('desc').value, a = document.getElementById('amt').value;
            if(!d || !a) return;
            const data = await localforage.getItem('finance_v2') || [];
            const entry = { desc: d, amt: Math.abs(parseFloat(a)), cat: currentCat, type: currentType, date: editIndex !== null ? data[editIndex].date : new Date().toISOString() };
            if (editIndex !== null) data[editIndex] = entry; else data.push(entry);
            await localforage.setItem('finance_v2', data);
            resetForm(); load();
        }

        async function startEdit(i) {
            const data = await localforage.getItem('finance_v2');
            const item = data[i]; editIndex = i;
            document.getElementById('desc').value = item.desc; document.getElementById('amt').value = item.amt;
            setCat(item.cat); setType(item.type);
            document.getElementById('add-btn').innerText = "Update"; document.getElementById('cancel-edit').classList.remove('hidden');
            document.getElementById('page-dashboard').scrollTo({ top: 0, behavior: 'smooth' });
            load();
        }

        function resetForm() {
            editIndex = null; document.getElementById('desc').value = ''; document.getElementById('amt').value = '';
            document.getElementById('add-btn').innerText = "Add"; document.getElementById('cancel-edit').classList.add('hidden');
            load();
        }

        async function deleteEntry(i) {
            if(!confirm("Delete?")) return;
            const d = await localforage.getItem('finance_v2');
            d.splice(i, 1); await localforage.setItem('finance_v2', d); load();
        }

        async function exportJSON() {
            const d = await localforage.getItem('finance_v2'), a = await localforage.getItem('accounts_v3');
            const b = new Blob([JSON.stringify({payload: d, accounts: a})], {type:'application/json'});
            const link = document.createElement('a'); link.href = URL.createObjectURL(b); link.download='finance_pro_backup.json'; link.click();
        }

        async function importJSON(e) {
            const f = e.target.files[0], r = new FileReader();
            r.onload = async (ev) => { 
                const i = JSON.parse(ev.target.result); 
                await localforage.setItem('finance_v2', i.payload); 
                await localforage.setItem('accounts_v3', i.accounts);
                load(); 
            };
            r.readAsText(f);
        }

        async function resetData() { if(confirm("Wipe all data?")) { await localforage.clear(); location.reload(); } }

        document.addEventListener('DOMContentLoaded', () => { renderTabs(); load(); });
    </script>
</body>
</html>
