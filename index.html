<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mindful Finance Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CALCULATOR FIXES */
        #calc-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Keeps buttons at bottom */
            align-items: center;
            z-index: 9999;
            padding-bottom: 40px;
        }
        .calc-container { width: 320px; }
        #calc-display { 
            color: white; 
            font-size: 80px; 
            text-align: right; 
            margin-bottom: 10px; 
            padding: 0 20px; 
            font-weight: 300; 
            line-height: 1;
            overflow: hidden;
            white-space: nowrap;
        }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 10px; }
        .c-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; cursor: pointer; transition: filter 0.1s; display: flex; align-items: center; justify-content: center; }
        .c-btn:active { filter: brightness(1.6); }
        .c-num { background-color: #333; color: white; }
        .c-op { background-color: #f1a33c; color: white; font-size: 35px; }
        .c-spec { background-color: #a5a5a5; color: black; font-size: 24px; }
        .c-zero { grid-column: span 2; width: 152px; border-radius: 40px; justify-content: flex-start; padding-left: 28px; }

        /* MAIN APP STYLES */
        body { background-color: #F9F7F2; -webkit-tap-highlight-color: transparent; overflow: hidden; font-family: sans-serif; }
        .card { background-color: #FFFFFF; border-radius: 24px; border: 1px solid #E5E2D9; }
        .btn-primary { background-color: #7DA67D; color: white; border-radius: 16px; transition: transform 0.1s; }
        .accent-text { color: #5B7A5B; }
        .tab { padding: 8px 12px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; cursor: pointer; background: #F0EEE6; color: #8A877F; text-transform: uppercase; }
        .tab.active { background: #7DA67D; color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #snap-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; height: 100vh; width: 100vw; }
        .page { min-width: 100vw; height: 100%; scroll-snap-align: start; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        #nav-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 10px 20px; border-radius: 20px; border: 1px solid #E5E2D9; z-index: 50; }
        .nav-btn { font-size: 10px; font-weight: 800; color: #8A877F; text-transform: uppercase; }
        .nav-btn.active { color: #7DA67D; }
        .dot { width: 5px; height: 5px; border-radius: 50%; background: #E5E2D9; }
        .dot.active { background: #7DA67D; width: 12px; border-radius: 3px; }
        
        /* LOCK BUTTON */
        .lock-btn { position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 1px solid #E5E2D9; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="calc-overlay">
        <div class="calc-container">
            <div id="calc-display">0</div>
            <div class="calc-buttons">
                <button class="c-btn c-spec" onclick="cClear()">AC</button>
                <button class="c-btn c-spec" onclick="cSign()">+/-</button>
                <button class="c-btn c-spec" onclick="cPercent()">%</button>
                <button class="c-btn c-op" onclick="cOp('/')">Ã·</button>
                <button class="c-btn c-num" onclick="cNum('7')">7</button>
                <button class="c-btn c-num" onclick="cNum('8')">8</button>
                <button class="c-btn c-num" onclick="cNum('9')">9</button>
                <button class="c-btn c-op" onclick="cOp('*')">Ã—</button>
                <button class="c-btn c-num" onclick="cNum('4')">4</button>
                <button class="c-btn c-num" onclick="cNum('5')">5</button>
                <button class="c-btn c-num" onclick="cNum('6')">6</button>
                <button class="c-btn c-op" onclick="cOp('-')">âˆ’</button>
                <button class="c-btn c-num" onclick="cNum('1')">1</button>
                <button class="c-btn c-num" onclick="cNum('2')">2</button>
                <button class="c-btn c-num" onclick="cNum('3')">3</button>
                <button class="c-btn c-op" onclick="cOp('+')">+</button>
                <button class="c-btn c-num c-zero" onclick="cNum('0')">0</button>
                <button class="c-btn c-num" onclick="cNum('.')">.</button>
                <button class="c-btn c-op" onclick="cEval()">=</button>
            </div>
        </div>
    </div>

    <div id="snap-container" onscroll="syncNav()">
        
        <div class="page" id="page-dashboard">
            <div class="lock-btn" onclick="location.reload()">ðŸ”’</div>
            <header class="mb-6 text-center pt-4">
                <h1 class="text-[10px] uppercase tracking-[0.2em] text-stone-400 font-bold mb-1">Calc Finance</h1>
                <div id="net-worth" class="text-4xl font-light accent-text mb-2">Â£0.00</div>
                <div id="stat-surplus" class="inline-block text-[10px] font-bold mt-1 uppercase tracking-tighter px-4 py-1.5 rounded-full border">
                    Surplus: Â£0.00
                </div>
            </header>

            <div id="wealth-grid" class="grid grid-cols-3 gap-2 mb-6 text-center"></div>

            <div id="input-card" class="card p-6 mb-6 shadow-sm border-stone-200">
                <div class="flex justify-between items-center mb-4">
                    <p id="form-title" class="text-[10px] uppercase text-stone-500 font-black">Transaction</p>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden text-[10px] font-bold text-red-400">CANCEL</button>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-4 mb-2 no-scrollbar" id="cat-selector"></div>
                <div class="space-y-3">
                    <div class="flex bg-stone-100 p-1 rounded-xl">
                        <button onclick="setType('out')" id="tgl-out" class="flex-1 py-2 rounded-lg text-xs font-bold transition bg-white shadow-sm text-red-500">EXPENSE</button>
                        <button onclick="setType('in')" id="tgl-in" class="flex-1 py-2 rounded-lg text-xs font-bold transition text-stone-400">INCOME</button>
                    </div>
                    <div id="income-type-container" class="hidden flex gap-2 bg-stone-50 p-1 rounded-xl">
                        <button onclick="setIncomeSub('active')" id="sub-active" class="flex-1 py-1.5 rounded-lg text-[10px] font-black bg-white shadow-xs">ACTIVE</button>
                        <button onclick="setIncomeSub('passive')" id="sub-passive" class="flex-1 py-1.5 rounded-lg text-[10px] font-black text-stone-400">PASSIVE</button>
                    </div>
                    <input id="desc" type="text" placeholder="Description" class="w-full bg-stone-50 p-3 rounded-xl">
                    <div class="flex gap-2">
                        <input id="amt" type="number" inputmode="decimal" placeholder="0.00" class="w-full bg-stone-50 p-3 rounded-xl text-lg font-semibold">
                        <button onclick="addEntry()" id="add-btn" class="btn-primary px-8 font-bold">ADD</button>
                    </div>
                </div>
            </div>

            <div class="card p-5 mb-6 shadow-sm">
                <canvas id="spendChart" style="max-height: 160px;"></canvas>
            </div>
            
            <ul id="list" class="space-y-3"></ul>
        </div>

        <div class="page" id="page-portfolio">
            <header class="mb-8 pt-4 text-center">
                <h2 class="text-xs font-black text-stone-400 uppercase tracking-[0.2em]">Portfolio</h2>
            </header>
            <div id="account-list" class="space-y-4 mb-6"></div>
            <div class="card p-6">
                 <input id="new-acc-name" type="text" placeholder="Account Name" class="bg-stone-50 p-3 rounded-xl text-sm w-full mb-3">
                 <div class="flex gap-2">
                    <select id="new-acc-type" class="bg-stone-100 p-3 rounded-xl text-[10px] font-bold uppercase w-1/2">
                        <option value="savings">Savings</option>
                        <option value="investments">Invested</option>
                        <option value="debt">Debt</option>
                    </select>
                    <button onclick="addAccount()" class="btn-primary flex-1 py-3 text-[10px] font-black uppercase">Create</button>
                 </div>
            </div>
        </div>

        <div class="page" id="page-analytics">
            <header class="mb-6 pt-4 text-center">
                <h2 class="text-xs font-black text-stone-400 uppercase tracking-[0.2em]">Data History</h2>
            </header>
            <div id="table-cat-selector" class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar"></div>
            <div id="table-container" class="card p-4 overflow-hidden"></div>
            <div class="mt-6 flex gap-2">
                <button onclick="exportJSON()" class="flex-1 text-[10px] font-black bg-stone-100 p-4 rounded-2xl uppercase">Export</button>
                <button onclick="resetData()" class="flex-1 text-[10px] text-red-400 font-black bg-stone-100 p-4 rounded-2xl uppercase">Wipe</button>
            </div>
        </div>
    </div>

    <div id="nav-bar">
        <div class="nav-btn active" onclick="scrollToPage(0)">Dash</div>
        <div class="dot active"></div>
        <div class="nav-btn" onclick="scrollToPage(1)">Vault</div>
        <div class="dot"></div>
        <div class="nav-btn" onclick="scrollToPage(2)">History</div>
    </div>

    <script>
        /* CALCULATOR LOGIC */
        let cVal = "0", cPrev = "", cOpChar = null, cReset = false;
        const SECRET = "640673";
        const cDisp = document.getElementById("calc-display");

        function cNum(n) {
            if (cVal === "0" || cReset) { cVal = n; cReset = false; } 
            else { cVal += n; }
            cDisp.innerText = cVal;
        }
        function cOp(op) { cOpChar = op; cPrev = cVal; cReset = true; }
        function cClear() { cVal = "0"; cPrev = ""; cOpChar = null; cDisp.innerText = "0"; }
        function cSign() { cVal = (parseFloat(cVal) * -1).toString(); cDisp.innerText = cVal; }
        function cPercent() { cVal = (parseFloat(cVal) / 100).toString(); cDisp.innerText = cVal; }
        function cEval() {
            if (cVal === SECRET) { document.getElementById("calc-overlay").style.display = "none"; return; }
            if (!cOpChar || !cPrev) return;
            let res; const p = parseFloat(cPrev), c = parseFloat(cVal);
            switch(cOpChar) {
                case '+': res = p + c; break;
                case '-': res = p - c; break;
                case '*': res = p * c; break;
                case '/': res = p / c; break;
            }
            cVal = res.toString(); cOpChar = null; cPrev = ""; cReset = true; cDisp.innerText = cVal;
        }

        /* FINANCE APP LOGIC */
        let currentCat = 'Misc', tableFilterCat = 'All', currentType = 'out', currentIncomeSub = 'active', chartInstance = null, editIndex = null, ACCOUNTS = [];
        const CONFIG = { monthlyCategories: ['Housing', 'Food', 'Transport', 'Ent', 'Bills', 'Misc'], incomeCategories: ['Salary', 'Dividends', 'Rent', 'Freelance', 'Other'] };

        function syncNav() {
            const container = document.getElementById('snap-container');
            const index = Math.round(container.scrollLeft / window.innerWidth);
            const btns = document.querySelectorAll('.nav-btn');
            const dots = document.querySelectorAll('.dot');
            btns.forEach((btn, i) => btn.classList.toggle('active', i === index));
            dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
        }

        function scrollToPage(idx) { document.getElementById('snap-container').scrollTo({ left: idx * window.innerWidth, behavior: 'smooth' }); }
        function setCat(c) { currentCat = c; renderTabs(); }
        function setTableFilter(c) { tableFilterCat = c; renderTabs(); load(); }
        
        function setType(t) {
            currentType = t;
            const container = document.getElementById('income-type-container');
            if (t === 'in') {
                container.classList.remove('hidden');
                document.getElementById('tgl-in').className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-green-600";
                document.getElementById('tgl-out').className = "flex-1 py-2 rounded-lg text-xs font-bold text-stone-400";
            } else {
                container.classList.add('hidden');
                document.getElementById('tgl-out').className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-red-500";
                document.getElementById('tgl-in').className = "flex-1 py-2 rounded-lg text-xs font-bold text-stone-400";
            }
            renderTabs();
        }

        function setIncomeSub(s) {
            currentIncomeSub = s;
            document.getElementById('sub-active').className = s === 'active' ? "flex-1 py-1.5 rounded-lg text-[10px] font-black bg-white shadow-xs" : "flex-1 py-1.5 rounded-lg text-[10px] font-black text-stone-400";
            document.getElementById('sub-passive').className = s === 'passive' ? "flex-1 py-1.5 rounded-lg text-[10px] font-black bg-white shadow-xs text-green-600" : "flex-1 py-1.5 rounded-lg text-[10px] font-black text-stone-400";
        }

        function renderTabs() {
            const cats = currentType === 'out' ? CONFIG.monthlyCategories : CONFIG.incomeCategories;
            document.getElementById('cat-selector').innerHTML = cats.map(c => `<div class="tab ${currentCat === c ? 'active' : ''}" onclick="setCat('${c}')">${c}</div>`).join('');
            const tableCats = ['All', ...CONFIG.monthlyCategories, ...CONFIG.incomeCategories];
            document.getElementById('table-cat-selector').innerHTML = tableCats.map(c => `<div class="tab ${tableFilterCat === c ? 'active' : ''}" onclick="setTableFilter('${c}')">${c}</div>`).join('');
        }

        async function load() {
            const data = await localforage.getItem('finance_v2') || [];
            ACCOUNTS = await localforage.getItem('accounts_v3') || [];
            let mIn = 0, mOut = 0; const catSum = {};
            CONFIG.monthlyCategories.forEach(c => catSum[c] = 0);
            data.forEach(e => {
                const v = parseFloat(e.amt);
                if(e.type === 'in') mIn += v; else { mOut += v; if(catSum[e.cat] !== undefined) catSum[e.cat] += v; }
            });
            const totals = ACCOUNTS.reduce((acc, curr) => { acc[curr.type] += curr.balance; return acc; }, { savings: 0, investments: 0, debt: 0 });
            const netWorth = (totals.savings + totals.investments) - totals.debt;
            document.getElementById('net-worth').innerText = `Â£${netWorth.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('stat-surplus').innerText = `Surplus: Â£${(mIn - mOut).toLocaleString()}`;
            document.getElementById('wealth-grid').innerHTML = `<div class="card p-2"><p class="text-[8px] uppercase font-bold">Savings</p><p class="text-xs">Â£${totals.savings.toLocaleString()}</p></div><div class="card p-2"><p class="text-[8px] uppercase font-bold accent-text">Invested</p><p class="text-xs">Â£${totals.investments.toLocaleString()}</p></div><div class="card p-2"><p class="text-[8px] uppercase font-bold text-red-400">Debt</p><p class="text-xs">Â£${totals.debt.toLocaleString()}</p></div>`;
            document.getElementById('account-list').innerHTML = ACCOUNTS.map(a => `<div class="card p-4 flex justify-between items-center"><span class="text-xs font-bold uppercase">${a.name}</span><span class="text-xs font-bold">Â£${a.balance.toLocaleString()}</span></div>`).join('');
            updateChart(catSum); renderTabbedTable(data);
        }

        async function addEntry() {
            const d = document.getElementById('desc').value, a = document.getElementById('amt').value;
            if(!d || !a) return;
            const data = await localforage.getItem('finance_v2') || [];
            data.push({ desc: d, amt: Math.abs(parseFloat(a)), cat: currentCat, type: currentType, date: new Date().toISOString() });
            await localforage.setItem('finance_v2', data);
            document.getElementById('desc').value = ''; document.getElementById('amt').value = ''; load();
        }

        function updateChart(sums) {
            const ctx = document.getElementById('spendChart').getContext('2d');
            const labels = Object.keys(sums).filter(k => sums[k] > 0), values = labels.map(k => sums[k]);
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: ['#7DA67D', '#9DBE9D', '#C2D6C2', '#E5E2D9', '#8A877F', '#A67D7D'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } }, cutout: '78%' } });
        }

        function renderTabbedTable(data) {
            const filtered = tableFilterCat === 'All' ? data : data.filter(i => i.cat === tableFilterCat);
            let h = `<table><tbody>`;
            filtered.slice().reverse().forEach(e => { h += `<tr><td class="text-stone-600 text-xs py-2">${e.desc}</td><td class="text-right font-bold text-xs">Â£${parseFloat(e.amt).toLocaleString()}</td></tr>`; });
            document.getElementById('table-container').innerHTML = h + `</tbody></table>`;
        }

        async function addAccount() {
            const name = document.getElementById('new-acc-name').value;
            const type = document.getElementById('new-acc-type').value;
            if(!name) return;
            ACCOUNTS.push({ id: Date.now(), name, type, balance: 0 });
            await localforage.setItem('accounts_v3', ACCOUNTS);
            document.getElementById('new-acc-name').value = ''; load();
        }

        async function resetData() { if(confirm("Wipe all?")) { await localforage.clear(); location.reload(); } }
        async function exportJSON() { const d = await localforage.getItem('finance_v2'); alert(JSON.stringify(d)); }

        document.addEventListener('DOMContentLoaded', () => { renderTabs(); load(); });
    </script>
</body>
</html>
